{"version":3,"sources":["../src/index.js"],"names":["consts","Server","opts","handleDisconnect","console","log","sendServerHello","payload","Buffer","alloc","pos","writeUInt8","write","banner","writeUInt32LE","process","pid","salt","copy","writeUInt16LE","CLIENT_LONG_PASSWORD","CLIENT_CONNECT_WITH_DB","CLIENT_PROTOCOL_41","CLIENT_SECURE_CONNECTION","serverCharset","SERVER_STATUS_AUTOCOMMIT","fill","writeHeader","sendPacket","slice","handleData","data","length","incoming","push","gatherIncoming","socket","destroy","helloPacketHandler","packet","sendError","message","ptr","clientFlags","maxPacketSize","clientCharset","readUInt8","filler1","usernameEnd","indexOf","username","toString","scrambleBuff","scrambleLength","scramble","database","databaseEnd","onPacket","Promise","resolve","onAuthorize","then","authorized","normalPacketHandler","sendOK","catch","err","Object","assign","randomBytes","sequence","on","len","writeUIntLE","params","catalog","schema","db","table","orgTable","name","orgName","type","MYSQL_TYPE_STRING","flags","decimals","definitions","writeLengthCodedBinary","definition","field","val","writeLengthCodedString","columnLength","columnType","sendEOF","row","cell","rows","sendRow","warningCount","serverStatus","buf","remaining","readPackets","from","offset","packetLength","readUIntLE","packetCount","onCommand","command","extra","affectedRows","insertId","errno","sqlState","str","number"],"mappings":";;;;;;;;AACA;;IAAYA,M;;AACZ;;;;;;;;;;IAEqBC,M;AACpB,kBAAYC,IAAZ,EAAkB;AAAA;;AAAA;;AAAA,SAelBC,gBAfkB,GAeC,YAAM;AACxBC,cAAQC,GAAR,CAAY,YAAZ;AACA,KAjBiB;;AAAA,SA8GlBC,eA9GkB,GA8GA,YAAM;AACvB;AACA,UAAIC,UAAUC,OAAOC,KAAP,CAAa,GAAb,CAAd;AACA,UAAIC,MAAM,CAAV;AACAA,YAAMH,QAAQI,UAAR,CAAmB,EAAnB,EAAsBD,GAAtB,CAAN,CAJuB,CAIW;;AAElCA,aAAOH,QAAQK,KAAR,CAAc,MAAKC,MAAL,IAAe,cAA7B,EAA4CH,GAA5C,CAAP;AACAA,YAAMH,QAAQI,UAAR,CAAmB,CAAnB,EAAqBD,GAArB,CAAN;;AAEAA,YAAMH,QAAQO,aAAR,CAAsBC,QAAQC,GAA9B,EAAkCN,GAAlC,CAAN;;AAEAA,aAAO,MAAKO,IAAL,CAAUC,IAAV,CAAeX,OAAf,EAAuBG,GAAvB,EAA4B,CAA5B,EAA8B,CAA9B,CAAP;AACAA,YAAMH,QAAQI,UAAR,CAAmB,CAAnB,EAAqBD,GAArB,CAAN;;AAEAA,YAAMH,QAAQY,aAAR,CACLnB,OAAOoB,oBAAP,GACApB,OAAOqB,sBADP,GAEArB,OAAOsB,kBAFP,GAGAtB,OAAOuB,wBAJF,EAKJb,GALI,CAAN;;AAOA,UAAI,MAAKc,aAAT,EAAwB;AACvBd,cAAMH,QAAQI,UAAR,CAAmB,MAAKa,aAAxB,EAAsCd,GAAtC,CAAN;AACA,OAFD,MAEO;AACNA,cAAMH,QAAQI,UAAR,CAAmB,IAAnB,EAAwBD,GAAxB,CAAN,CADM,CAC8B;AACpC;AACDA,YAAMH,QAAQY,aAAR,CAAsBnB,OAAOyB,wBAA7B,EAAsDf,GAAtD,CAAN;AACAH,cAAQmB,IAAR,CAAa,CAAb,EAAehB,GAAf,EAAmBA,MAAI,EAAvB;AACAA,aAAO,EAAP;;AAEAA,aAAO,MAAKO,IAAL,CAAUC,IAAV,CAAeX,OAAf,EAAuBG,GAAvB,EAA2B,CAA3B,CAAP;AACAA,YAAMH,QAAQI,UAAR,CAAmB,CAAnB,EAAqBD,GAArB,CAAN;AACA,YAAKiB,WAAL,CAAiBpB,OAAjB,EAAyBG,GAAzB;;AAEA,aAAO,MAAKkB,UAAL,CAAgBrB,QAAQsB,KAAR,CAAc,CAAd,EAAgBnB,GAAhB,CAAhB,CAAP;AACA,KAjJiB;;AAAA,SAmJlBoB,UAnJkB,GAmJL,UAACC,IAAD,EAAU;AACtB,UAAIA,QAAQA,KAAKC,MAAL,GAAc,CAA1B,EAA6B;AAC5B,cAAKC,QAAL,CAAcC,IAAd,CAAmBH,IAAnB;AACA;AACD,YAAKI,cAAL;AACA,UAAIJ,QAAQ,IAAZ,EAAkB;AACjB3B,gBAAQC,GAAR,CAAY,mBAAZ;AACA,cAAK+B,MAAL,CAAYC,OAAZ;AACA;AACD,KA5JiB;;AAAA,SAmMlBC,kBAnMkB,GAmMG,UAACC,MAAD,EAAY;AAChC;;AAEA;;AAEA,UAAIA,OAAOP,MAAP,IAAiB,CAArB,EAAwB,OAAO,MAAKQ,SAAL,CAAe,EAAEC,SAAS,0BAAX,EAAf,CAAP;;AAExB,UAAIC,MAAM,CAAV;;AAEA,UAAIC,cAAcJ,OAAOV,KAAP,CAAaa,GAAb,EAAiBA,MAAI,CAArB,CAAlB;AACAA,aAAO,CAAP;;AAEA,UAAIE,gBAAgBL,OAAOV,KAAP,CAAaa,GAAb,EAAiBA,MAAI,CAArB,CAApB;AACAA,aAAO,CAAP;;AAEA,YAAKG,aAAL,GAAqBN,OAAOO,SAAP,CAAiBJ,GAAjB,CAArB;AACAA;;AAEA,UAAIK,UAAUR,OAAOV,KAAP,CAAaa,GAAb,EAAiBA,MAAI,EAArB,CAAd;AACAA,aAAO,EAAP;;AAEA,UAAIM,cAAcT,OAAOU,OAAP,CAAe,CAAf,EAAiBP,GAAjB,CAAlB;AACA,UAAIQ,WAAWX,OAAOY,QAAP,CAAgB,OAAhB,EAAwBT,GAAxB,EAA4BM,WAA5B,CAAf;AACAN,YAAMM,cAAc,CAApB;;AAEA,UAAII,qBAAJ;;AAEA,UAAIC,iBAAiBd,OAAOO,SAAP,CAAiBJ,GAAjB,CAArB;AACAA;;AAEA,UAAIW,iBAAiB,CAArB,EAAwB;AACvB,cAAKC,QAAL,GAAgBf,OAAOV,KAAP,CAAaa,GAAb,EAAiBA,MAAIW,cAArB,CAAhB;AACAX,eAAOW,cAAP;AACA;;AAED,UAAIE,iBAAJ;;AAEA,UAAIC,cAAcjB,OAAOU,OAAP,CAAe,CAAf,EAAiBP,GAAjB,CAAlB;AACA,UAAIc,eAAe,CAAnB,EAAsB;AACrBD,mBAAWxB,KAAKoB,QAAL,CAAc,OAAd,EAAsBT,GAAtB,EAA0Bc,WAA1B,CAAX;AACA;AACD,YAAKC,QAAL,GAAgB,IAAhB;;AAEA,aAAOC,QAAQC,OAAR,CAAgB,MAAKC,WAAL,CAAiB,EAAEjB,wBAAF,EAAeC,4BAAf,EAA8BM,kBAA9B,EAAwCK,kBAAxC,EAAjB,CAAhB,EACNM,IADM,CACA,UAACC,UAAD,EAAgB;AACtB,YAAI,CAAEA,UAAN,EAAkB,MAAM,gBAAN;;AAElB,cAAKL,QAAL,GAAgB,MAAKM,mBAArB;AACA,cAAK5B,cAAL;AACA,cAAK6B,MAAL,CAAY,EAAEvB,SAAS,IAAX,EAAZ;AACA,OAPM,EAQNwB,KARM,CAQC,UAACC,GAAD,EAAS;AAChB9D,gBAAQC,GAAR,CAAY6D,GAAZ;AACA,cAAK1B,SAAL,CAAgB,EAAEC,SAAS,uBAAX,EAAhB;AACA,cAAKL,MAAL,CAAYC,OAAZ;AACA,OAZM,CAAP;AAaA,KA3PiB;;AACjB8B,WAAOC,MAAP,CAAc,IAAd,EAAmBlE,IAAnB;;AAEA,QAAI,CAAE,KAAKW,MAAX,EAAmB,KAAKA,MAAL,GAAc,cAAd;AACnB;AACA,QAAI,CAAE,KAAKI,IAAX,EAAiB,KAAKA,IAAL,GAAY,iBAAOoD,WAAP,CAAmB,EAAnB,CAAZ;AACjB,SAAKC,QAAL,GAAgB,CAAhB;AACA,SAAKb,QAAL,GAAgB,KAAKnB,kBAArB;AACA,SAAKL,QAAL,GAAgB,EAAhB;;AAEA,SAAKG,MAAL,CAAYmC,EAAZ,CAAe,MAAf,EAAuB,KAAKzC,UAA5B;AACA,SAAKM,MAAL,CAAYmC,EAAZ,CAAe,KAAf,EAAsB,KAAKpE,gBAA3B;;AAEA,SAAKG,eAAL;AACA;;;;gCAKWyB,I,EAAKyC,G,EAAK;AACrB;AACAzC,WAAK0C,WAAL,CAAiBD,MAAM,CAAvB,EAAyB,CAAzB,EAA2B,CAA3B;AACAzC,WAAKpB,UAAL,CAAgB,KAAK2D,QAAL,KAAkB,GAAlC,EAAuC,CAAvC;AACA;;;+BAEU/D,O,EAAS;AACnB;AACA;AACA,aAAO,KAAK6B,MAAL,CAAYxB,KAAZ,CAAkBL,OAAlB,CAAP;AACA;;;kCAEamE,M,EAAQ;AACrB,aAAO;AACNC,iBAASD,OAAOC,OAAP,GAAiBD,OAAOC,OAAxB,GAAkC,KADrC;AAENC,gBAAQF,OAAOG,EAFT;AAGNC,eAAOJ,OAAOI,KAHR;AAINC,kBAAUL,OAAOK,QAJX;AAKNC,cAAMN,OAAOM,IALP;AAMNC,iBAASP,OAAOO,OANV;AAONjD,gBAAQ0C,OAAO1C,MAAP,GAAgB0C,OAAO1C,MAAvB,GAAgC,CAPlC;AAQNkD,cAAMR,OAAOQ,IAAP,GAAcR,OAAOQ,IAArB,GAA4BlF,OAAOmF,iBARnC;AASNC,eAAOV,OAAOU,KAAP,GAAeV,OAAOU,KAAtB,GAA8B,CAT/B;AAUNC,kBAAUX,OAAOW,QAVX;AAWN,mBAAWX,OAAO,SAAP;AAXL,OAAP;AAaA;;;oCAEeY,W,EAAa;AAC5B;AACA,UAAI/E,UAAUC,OAAOC,KAAP,CAAa,IAAb,CAAd;AACA,UAAI+D,MAAM,CAAV;AACAA,YAAMe,uBAAuBhF,OAAvB,EAA+BiE,GAA/B,EAAmCc,YAAYtD,MAA/C,CAAN;AACA,WAAKL,WAAL,CAAiBpB,OAAjB,EAAyBiE,GAAzB;AACA,WAAK5C,UAAL,CAAgBrB,QAAQsB,KAAR,CAAc,CAAd,EAAgB2C,GAAhB,CAAhB;;AAEA;AACAA,YAAM,CAAN;AAT4B;AAAA;AAAA;;AAAA;AAU5B,6BAAuBc,WAAvB,8HAAoC;AAAA,cAA3BE,UAA2B;AAAA,qBACjB,CAAE,SAAF,EAAY,QAAZ,EAAqB,OAArB,EAA6B,UAA7B,EAAwC,MAAxC,EAA+C,SAA/C,CADiB;;AACnC,mDAA8E;AAAzE,gBAAIC,gBAAJ;AACJ,gBAAIC,MAAMF,WAAWC,KAAX,KAAqB,EAA/B;AACAjB,kBAAMmB,uBAAuBpF,OAAvB,EAA+BiE,GAA/B,EAAmCkB,GAAnC,CAAN;AACA;AACDlB,gBAAMjE,QAAQI,UAAR,CAAmB,IAAnB,EAAyB6D,GAAzB,CAAN;AACAA,gBAAMjE,QAAQY,aAAR,CAAsB,EAAtB,EAA0BqD,GAA1B,CAAN,CANmC,CAMG;AACtCA,gBAAMjE,QAAQO,aAAR,CAAsB0E,WAAWI,YAAjC,EAA+CpB,GAA/C,CAAN;AACAA,gBAAMjE,QAAQI,UAAR,CAAmB6E,WAAWK,UAA9B,EAA0CrB,GAA1C,CAAN;AACAA,gBAAMjE,QAAQY,aAAR,CAAsBqE,WAAWJ,KAAX,GAAmBI,WAAWJ,KAA9B,GAAsC,CAA5D,EAA+DZ,GAA/D,CAAN;AACAA,gBAAMjE,QAAQI,UAAR,CAAmB6E,WAAWH,QAAX,GAAsBG,WAAWH,QAAjC,GAA4C,CAA/D,EAAkEb,GAAlE,CAAN;AACAA,gBAAMjE,QAAQY,aAAR,CAAsB,CAAtB,EAAwBqD,GAAxB,CAAN,CAXmC,CAWC;AACpCA,gBAAMmB,uBAAuBpF,OAAvB,EAA+BiE,GAA/B,EAAmCgB,WAAW,SAAX,CAAnC,CAAN;AACA,eAAK7D,WAAL,CAAiBpB,OAAjB,EAAyBiE,GAAzB;AACA,eAAK5C,UAAL,CAAgBrB,QAAQsB,KAAR,CAAc,CAAd,EAAgB2C,GAAhB,CAAhB;AACA;AAzB2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA2B5B,WAAKsB,OAAL;AACA;;;4BAEOC,G,EAAK;AACZ,UAAIxF,UAAUC,OAAOC,KAAP,CAAa,IAAb,CAAd;AACA,UAAI+D,MAAM,CAAV;AAFY;AAAA;AAAA;;AAAA;AAGZ,8BAAiBuB,GAAjB,mIAAsB;AAAA,cAAbC,IAAa;;AACrB,cAAIA,QAAQ,IAAZ,EAAkB;AACjBxB,kBAAMjE,QAAQI,UAAR,CAAmB,IAAnB,EAAwB6D,GAAxB,CAAN;AACA,WAFD,MAEO;AACNA,kBAAMmB,uBAAuBpF,OAAvB,EAA+BiE,GAA/B,EAAmCwB,IAAnC,CAAN;AACA;AACD;AATW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAUZ,WAAKrE,WAAL,CAAiBpB,OAAjB,EAAyBiE,GAAzB;AACA,WAAK5C,UAAL,CAAgBrB,QAAQsB,KAAR,CAAc,CAAd,EAAgB2C,GAAhB,CAAhB;AACA;;;+BAEmB;AAAA,UAAXyB,IAAW,uEAAJ,EAAI;AAAA;AAAA;AAAA;;AAAA;AACnB,8BAAgBA,IAAhB,mIAAsB;AAAA,cAAbF,GAAa;;AACrB,eAAKG,OAAL,CAAaH,GAAb;AACA;AAHkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAInB,WAAKD,OAAL;AACA;;;8BAGgF;AAAA,qFAAJ,EAAI;AAAA,mCAAxEK,YAAwE;AAAA,UAAxEA,YAAwE,qCAAzD,CAAyD;AAAA,mCAAtDC,YAAsD;AAAA,UAAtDA,YAAsD,qCAAvCpG,OAAOyB,wBAAgC;;AAChF;AACA,UAAIlB,UAAUC,OAAOC,KAAP,CAAa,EAAb,CAAd;AACA,UAAI+D,MAAM,CAAV;AACAA,YAAMjE,QAAQI,UAAR,CAAmB,IAAnB,EAAwB6D,GAAxB,CAAN;AACAA,YAAMjE,QAAQY,aAAR,CAAsBgF,YAAtB,EAAmC3B,GAAnC,CAAN;AACAA,YAAMjE,QAAQY,aAAR,CAAsBiF,YAAtB,EAAmC5B,GAAnC,CAAN;AACA,WAAK7C,WAAL,CAAiBpB,OAAjB,EAAyBiE,GAAzB;AACA,WAAK5C,UAAL,CAAgBrB,QAAQsB,KAAR,CAAc,CAAd,EAAgB2C,GAAhB,CAAhB;AACA;;;qCAkDgB;AAChB,UAAIvC,iBAAJ;AACA,UAAI,KAAKA,QAAL,CAAcD,MAAd,GAAuB,CAA3B,EAA8B;AAC7B,YAAIwC,MAAM,CAAV;AAD6B;AAAA;AAAA;;AAAA;AAE7B,gCAAgB,KAAKvC,QAArB,mIAA+B;AAAA,gBAAtBoE,GAAsB;;AAC9B7B,mBAAO6B,IAAIrE,MAAX;AACA;AAJ4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAK7BC,mBAAWzB,OAAOC,KAAP,CAAa+D,GAAb,CAAX;AACAA,cAAM,CAAN;AAN6B;AAAA;AAAA;;AAAA;AAO7B,gCAAgB,KAAKvC,QAArB,mIAA+B;AAAA,gBAAtBoE,IAAsB;;AAC9B7B,mBAAO6B,KAAInF,IAAJ,CAASe,QAAT,EAAkBuC,GAAlB,CAAP;AACA;AAT4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAU7B,OAVD,MAUO;AACNvC,mBAAW,KAAKA,QAAL,CAAc,CAAd,CAAX;AACA;AACD,UAAIqE,YAAY,KAAKC,WAAL,CAAiBtE,QAAjB,CAAhB;AACA,WAAKA,QAAL,GAAgB,CAACzB,OAAOgG,IAAP,CAAYF,SAAZ,CAAD,CAAhB;AACA;;;gCAEWD,G,EAAK;AAChB,UAAII,SAAS,CAAb;AACA,aAAO,IAAP,EAAa;AACZ,YAAI1E,QAAOsE,IAAIxE,KAAJ,CAAU4E,MAAV,CAAX;AACA,YAAI1E,MAAKC,MAAL,GAAc,CAAlB,EAAqB,OAAOD,KAAP;;AAErB,YAAI2E,eAAe3E,MAAK4E,UAAL,CAAgB,CAAhB,EAAkB,CAAlB,CAAnB;AACA,YAAI5E,MAAKC,MAAL,GAAc0E,eAAe,CAAjC,EAAoC,OAAO3E,KAAP;;AAEpC,aAAKuC,QAAL,GAAgBvC,MAAK4E,UAAL,CAAgB,CAAhB,IAAqB,CAArC;AACAF,kBAAUC,eAAe,CAAzB;AACA,YAAInE,SAASR,MAAKF,KAAL,CAAW,CAAX,EAAa6E,eAAe,CAA5B,CAAb;;AAEA,aAAKjD,QAAL,CAAclB,MAAd;AACA,aAAKqE,WAAL;AACA;AACD;;;wCA4DmBrE,M,EAAQ;AAC3B,UAAIA,UAAU,IAAd,EAAoB,MAAM,cAAN;AACpB,aAAO,KAAKsE,SAAL,CAAe;AACrBC,iBAASvE,OAAOO,SAAP,CAAiB,CAAjB,CADY;AAErBiE,eAAOxE,OAAOP,MAAP,GAAgB,CAAhB,GAAoBO,OAAOV,KAAP,CAAa,CAAb,CAApB,GAAsC;AAFxB,OAAf,CAAP;AAIA;;;kCACgE;AAAA,UAAxDY,OAAwD,SAAxDA,OAAwD;AAAA,qCAA/CuE,YAA+C;AAAA,UAA/CA,YAA+C,sCAAhC,CAAgC;AAAA,UAA7BC,QAA6B,SAA7BA,QAA6B;AAAA,qCAAnBd,YAAmB;AAAA,UAAnBA,YAAmB,sCAAJ,CAAI;;AAChE,UAAIpE,OAAOvB,OAAOC,KAAP,CAAagC,QAAQT,MAAR,GAAiB,EAA9B,CAAX;AACA,UAAIwC,MAAM,CAAV;AACAA,YAAMzC,KAAKpB,UAAL,CAAgB,CAAhB,EAAkB6D,GAAlB,CAAN;AACAA,YAAMe,uBAAuBxD,IAAvB,EAA4ByC,GAA5B,EAAgCwC,YAAhC,CAAN;AACAxC,YAAMe,uBAAuBxD,IAAvB,EAA4ByC,GAA5B,EAAgCyC,QAAhC,CAAN;AACAzC,YAAMzC,KAAKZ,aAAL,CAAmBnB,OAAOyB,wBAA1B,EAAmD+C,GAAnD,CAAN;AACAA,YAAMzC,KAAKZ,aAAL,CAAmBgF,YAAnB,EAAgC3B,GAAhC,CAAN;AACAA,YAAMmB,uBAAuB5D,IAAvB,EAA4ByC,GAA5B,EAAgC/B,OAAhC,CAAN;;AAEA,WAAKd,WAAL,CAAiBI,IAAjB,EAAsByC,GAAtB;AACA,WAAK5C,UAAL,CAAgBG,KAAKF,KAAL,CAAW,CAAX,EAAa2C,GAAb,CAAhB;AACA;;;qCAE6E;AAAA,gCAAlE/B,OAAkE;AAAA,UAAlEA,OAAkE,iCAAxD,qBAAwD;AAAA,8BAAlCyE,KAAkC;AAAA,UAAlCA,KAAkC,+BAA1B,IAA0B;AAAA,iCAArBC,QAAqB;AAAA,UAArBA,QAAqB,kCAAV,OAAU;;AAC7E;AACA/G,cAAQC,GAAR,CAAYoC,OAAZ;AACA,UAAIV,OAAOvB,OAAOC,KAAP,CAAagC,QAAQT,MAAR,GAAiB,EAA9B,CAAX;AACA,UAAIwC,MAAM,CAAV;AACAA,YAAMzC,KAAKpB,UAAL,CAAgB,IAAhB,EAAqB6D,GAArB,CAAN;AACAA,YAAMzC,KAAKZ,aAAL,CAAmB+F,KAAnB,EAAyB1C,GAAzB,CAAN;AACAA,aAAOzC,KAAKnB,KAAL,CAAW,GAAX,EAAe4D,GAAf,CAAP;AACAA,aAAOzC,KAAKnB,KAAL,CAAWuG,QAAX,EAAoB3C,GAApB,EAAwB,CAAxB,CAAP;AACAA,aAAOzC,KAAKnB,KAAL,CAAW6B,OAAX,EAAmB+B,GAAnB,CAAP;AACAA,YAAMzC,KAAKpB,UAAL,CAAgB,CAAhB,EAAkB6D,GAAlB,CAAN;;AAEA,WAAK7C,WAAL,CAAiBI,IAAjB,EAAsByC,GAAtB;AACA,WAAK5C,UAAL,CAAgBG,KAAKF,KAAL,CAAW,CAAX,EAAa2C,GAAb,CAAhB;AACA;;;;;;kBAjSmBvE,M;;AAmSrB,SAAS0F,sBAAT,CAAgCU,GAAhC,EAAoC3F,GAApC,EAAwC0G,GAAxC,EAA6C;AAC5C,MAAIA,OAAO,IAAX,EAAiB,OAAOf,IAAI1F,UAAJ,CAAe,CAAf,EAAiBD,GAAjB,CAAP;AACjB,MAAI,OAAO0G,GAAP,KAAe,QAAnB,EAA6B;AAC5B;AACAA,UAAMA,IAAIjE,QAAJ,EAAN;AACA;AACDkD,MAAI1F,UAAJ,CAAe,GAAf,EAAmBD,GAAnB;AACA2F,MAAI5B,WAAJ,CAAgB2C,IAAIpF,MAApB,EAA2BtB,MAAM,CAAjC,EAAoC,CAApC;AACA2F,MAAIzF,KAAJ,CAAUwG,GAAV,EAAc1G,MAAM,CAApB;AACA,SAAOA,MAAM0G,IAAIpF,MAAV,GAAmB,CAA1B;AACA;;AAED,SAASuD,sBAAT,CAAgCc,GAAhC,EAAoC3F,GAApC,EAAwC2G,MAAxC,EAAgD;AAC/C,MAAIA,UAAU,IAAd,EAAoB;AACnB,WAAOhB,IAAI1F,UAAJ,CAAe,GAAf,EAAmBD,GAAnB,CAAP;AACA,GAFD,MAEO,IAAI2G,SAAS,GAAb,EAAkB;AACxB,WAAOhB,IAAI1F,UAAJ,CAAe0G,MAAf,EAAsB3G,GAAtB,CAAP;AACA,GAFM,MAEA,IAAI2G,SAAS,OAAb,EAAsB;AAC5BhB,QAAI1F,UAAJ,CAAe,GAAf,EAAmBD,GAAnB;AACA2F,QAAIlF,aAAJ,CAAkBkG,MAAlB,EAAyB3G,MAAM,CAA/B;AACA,WAAOA,MAAM,CAAb;AACA,GAJM,MAIA,IAAI2G,SAAS,SAAb,EAAwB;AAC9BhB,QAAI1F,UAAJ,CAAe,GAAf,EAAmBD,GAAnB;AACA2F,QAAI5B,WAAJ,CAAgB4C,MAAhB,EAAuB3G,MAAM,CAA7B,EAA+B,CAA/B;AACA,WAAOA,MAAM,CAAb;AACA,GAJM,MAIA;AACN2F,QAAI1F,UAAJ,CAAe,GAAf,EAAmBD,GAAnB;AACA2F,QAAI5B,WAAJ,CAAgB4C,MAAhB,EAAuB3G,MAAM,CAA7B,EAA+B,CAA/B;AACA,WAAOA,MAAM,CAAb;AACA;AACD","file":"index.js","sourcesContent":["\nimport * as consts from './constants';\nimport crypto from 'crypto';\n\nexport default class Server {\n constructor(opts) {\n  Object.assign(this,opts);\n  \n  if (! this.banner) this.banner = \"MyServer/1.0\";\n  //if (! this.serverCharset) this.serverCharset = consts.MYSERVER_SERVER_CHARSET;\n  if (! this.salt) this.salt = crypto.randomBytes(20); \n  this.sequence = 0;\n  this.onPacket = this.helloPacketHandler;\n  this.incoming = [];\n  \n  this.socket.on('data', this.handleData);\n  this.socket.on('end', this.handleDisconnect);\n  \n  this.sendServerHello()\n }\n handleDisconnect = () => {\n  console.log(\"disconnect\");\n };\n\n writeHeader(data,len) {\n  //console.log(\"Sequence: \" + this.sequence);\n  data.writeUIntLE(len - 4,0,3);\n  data.writeUInt8(this.sequence++ % 256, 3);\n }\n\n sendPacket(payload) {\n  //console.log(\"Sending Packet: \" + payload);\n  //console.log(payload);\n  return this.socket.write(payload);\n }\n \n newDefinition(params) {\n  return {\n   catalog: params.catalog ? params.catalog : 'def',\n   schema: params.db,\n   table: params.table,\n   orgTable: params.orgTable,\n   name: params.name,\n   orgName: params.orgName,\n   length: params.length ? params.length : 0,\n   type: params.type ? params.type : consts.MYSQL_TYPE_STRING,\n   flags: params.flags ? params.flags : 0,\n   decimals: params.decimals,\n   'default': params['default'],\n  };\n }\n\n sendDefinitions(definitions) {\n  // Write Definition Header\n  let payload = Buffer.alloc(1024);\n  let len = 4;\n  len = writeLengthCodedBinary(payload,len,definitions.length);\n  this.writeHeader(payload,len); \n  this.sendPacket(payload.slice(0,len));\n\n  // Write each definition\n  len = 4;\n  for (let definition of definitions) {\n   for (let field of [ 'catalog','schema','table','orgTable','name','orgName' ]) {\n    let val = definition[field] || \"\";\n    len = writeLengthCodedString(payload,len,val);\n   }\n   len = payload.writeUInt8(0x0C, len);\n   len = payload.writeUInt16LE(11, len); // ASCII\n   len = payload.writeUInt32LE(definition.columnLength, len);\n   len = payload.writeUInt8(definition.columnType, len);\n   len = payload.writeUInt16LE(definition.flags ? definition.flags : 0, len);\n   len = payload.writeUInt8(definition.decimals ? definition.decimals : 0, len);\n   len = payload.writeUInt16LE(0,len); // \\0\\0 FILLER\n   len = writeLengthCodedString(payload,len,definition['default']);\n   this.writeHeader(payload,len); \n   this.sendPacket(payload.slice(0,len));\n  }\n  \n  this.sendEOF();\n }\n\n sendRow(row) {\n  let payload = Buffer.alloc(1024);\n  let len = 4;\n  for (let cell of row) {\n   if (cell == null) {\n    len = payload.writeUInt8(0xFB,len);\n   } else {\n    len = writeLengthCodedString(payload,len,cell);\n   }\n  }\n  this.writeHeader(payload,len); \n  this.sendPacket(payload.slice(0,len));\n }\n\n sendRows(rows = []) {\n  for (let row of rows) {\n   this.sendRow(row);\n  }\n  this.sendEOF();\n }\n\n\n sendEOF({warningCount = 0, serverStatus = consts.SERVER_STATUS_AUTOCOMMIT} = {}) {\n  // Write EOF\n  let payload = Buffer.alloc(16);\n  let len = 4;\n  len = payload.writeUInt8(0xFE,len);\n  len = payload.writeUInt16LE(warningCount,len);\n  len = payload.writeUInt16LE(serverStatus,len);\n  this.writeHeader(payload,len); \n  this.sendPacket(payload.slice(0,len));\n }\n\n sendServerHello = () => {\n  //## Sending Server Hello...\n  let payload = Buffer.alloc(128);\n  let pos = 4;\n  pos = payload.writeUInt8(10,pos); // Protocol version\n  \n  pos += payload.write(this.banner || \"MyServer/1.0\",pos);\n  pos = payload.writeUInt8(0,pos);\n\n  pos = payload.writeUInt32LE(process.pid,pos);\n\n  pos += this.salt.copy(payload,pos, 0,8);\n  pos = payload.writeUInt8(0,pos);\n\n  pos = payload.writeUInt16LE(\n   consts.CLIENT_LONG_PASSWORD | \n   consts.CLIENT_CONNECT_WITH_DB | \n   consts.CLIENT_PROTOCOL_41 | \n   consts.CLIENT_SECURE_CONNECTION\n  , pos);\n\n  if (this.serverCharset) {\n   pos = payload.writeUInt8(this.serverCharset,pos);\n  } else {\n   pos = payload.writeUInt8(0x21,pos); // latin1\n  }\n  pos = payload.writeUInt16LE(consts.SERVER_STATUS_AUTOCOMMIT,pos);\n  payload.fill(0,pos,pos+13);\n  pos += 13;\n\n  pos += this.salt.copy(payload,pos,8);\n  pos = payload.writeUInt8(0,pos);\n  this.writeHeader(payload,pos); \n\n  return this.sendPacket(payload.slice(0,pos));\n }\n\n handleData = (data) => {\n  if (data && data.length > 0) {\n   this.incoming.push(data);\n  }\n  this.gatherIncoming();\n  if (data == null) {\n   console.log(\"Connection closed\");\n   this.socket.destroy();\n  }\n }\n \n gatherIncoming() {\n  let incoming;\n  if (this.incoming.length > 0) {\n   let len = 0;\n   for (let buf of this.incoming) {\n    len += buf.length;\n   }\n   incoming = Buffer.alloc(len);\n   len = 0;\n   for (let buf of this.incoming) {\n    len += buf.copy(incoming,len); \n   }\n  } else {\n   incoming = this.incoming[0];\n  }\n  let remaining = this.readPackets(incoming);\n  this.incoming = [Buffer.from(remaining)];\n }\n \n readPackets(buf) {\n  let offset = 0;\n  while (true) {\n   let data = buf.slice(offset);\n   if (data.length < 4) return data;\n  \n   let packetLength = data.readUIntLE(0,3);\n   if (data.length < packetLength + 4) return data;\n\n   this.sequence = data.readUIntLE(3) + 1;\n   offset += packetLength + 4;\n   let packet = data.slice(4,packetLength + 4);\n   \n   this.onPacket(packet);\n   this.packetCount++; \n  }\n }\n\n helloPacketHandler = (packet) => {\n  //## Reading Client Hello...\n\n  // http://dev.mysql.com/doc/internals/en/the-packet-header.html\n\n  if (packet.length == 0) return this.sendError({ message: \"Zero length hello packet\" });\n\n  let ptr = 0;\n\n  let clientFlags = packet.slice(ptr,ptr+4);\n  ptr += 4;\n\n  let maxPacketSize = packet.slice(ptr,ptr+4);\n  ptr += 4;\n\n  this.clientCharset = packet.readUInt8(ptr);\n  ptr++;\n \n  let filler1 = packet.slice(ptr,ptr+23);\n  ptr += 23;\n\n  let usernameEnd = packet.indexOf(0,ptr);\n  let username = packet.toString('ascii',ptr,usernameEnd);\n  ptr = usernameEnd + 1;\n\n  let scrambleBuff;\n\n  let scrambleLength = packet.readUInt8(ptr);\n  ptr++;\n\n  if (scrambleLength > 0) {\n   this.scramble = packet.slice(ptr,ptr+scrambleLength);\n   ptr += scrambleLength;\n  }\n \n  let database;\n\n  let databaseEnd = packet.indexOf(0,ptr);\n  if (databaseEnd >= 0) {\n   database = data.toString('ascii',ptr,databaseEnd);\n  }\n  this.onPacket = null;\n    \n  return Promise.resolve(this.onAuthorize({ clientFlags, maxPacketSize, username, database }))\n  .then( (authorized) => {\n   if (! authorized) throw \"Not Authorized\";\n\n   this.onPacket = this.normalPacketHandler;\n   this.gatherIncoming();\n   this.sendOK({ message: \"OK\" });\n  })\n  .catch( (err) => {\n   console.log(err);\n   this.sendError( { message: \"Authorization Failure\" } );\n   this.socket.destroy();\n  });\n }\n\n normalPacketHandler(packet) {\n  if (packet == null) throw \"Empty packet\";\n  return this.onCommand({\n   command: packet.readUInt8(0),\n   extra: packet.length > 1 ? packet.slice(1) : null\n  });\n }\n sendOK({ message, affectedRows = 0, insertId, warningCount = 0}) {\n  let data = Buffer.alloc(message.length + 64);\n  let len = 4;\n  len = data.writeUInt8(0,len);\n  len = writeLengthCodedBinary(data,len,affectedRows);\n  len = writeLengthCodedBinary(data,len,insertId);\n  len = data.writeUInt16LE(consts.SERVER_STATUS_AUTOCOMMIT,len);\n  len = data.writeUInt16LE(warningCount,len);\n  len = writeLengthCodedString(data,len,message);\n\n  this.writeHeader(data,len);\n  this.sendPacket(data.slice(0,len));\n }\n\n sendError({ message = 'Unknown MySQL error',errno = 2000,sqlState = \"HY000\"}) {\n  //## Sending Error ...\n  console.log(message);\n  let data = Buffer.alloc(message.length + 64);\n  let len = 4;\n  len = data.writeUInt8(0xFF,len);\n  len = data.writeUInt16LE(errno,len);\n  len += data.write(\"#\",len);\n  len += data.write(sqlState,len,5);\n  len += data.write(message,len);\n  len = data.writeUInt8(0,len);\n\n  this.writeHeader(data,len);\n  this.sendPacket(data.slice(0,len));\n }\n}\nfunction writeLengthCodedString(buf,pos,str) {\n if (str == null) return buf.writeUInt8(0,pos);\n if (typeof str !== 'string') {\n  //Mangle it\n  str = str.toString();\n }\n buf.writeUInt8(253,pos);\n buf.writeUIntLE(str.length,pos + 1, 3);\n buf.write(str,pos + 4);\n return pos + str.length + 4;\n}\n\nfunction writeLengthCodedBinary(buf,pos,number) {\n if (number == null) {\n  return buf.writeUInt8(251,pos);\n } else if (number < 251) {\n  return buf.writeUInt8(number,pos);\n } else if (number < 0x10000) {\n  buf.writeUInt8(252,pos);\n  buf.writeUInt16LE(number,pos + 1);\n  return pos + 3;\n } else if (number < 0x1000000) {\n  buf.writeUInt8(253,pos);\n  buf.writeUIntLE(number,pos + 1,3);\n  return pos + 4;\n } else {\n  buf.writeUInt8(254,pos);\n  buf.writeUIntLE(number,pos + 1,8);\n  return pos + 9;\n }\n}\n"]}